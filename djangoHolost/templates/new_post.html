{% extends 'layout.html' %}
{% load static %}
{% block title %}Создание рецепта{% endblock %}

{% block content %}
<script src="{% static '/js/script_post.js' %}" type="text/javascript" defer></script>
<div class="centerbox2">
        {% if messages %}
    <div class="messages-popup">
        <ul class="messages">
          {% for message in messages %}
            {% if "error" in message.tags %}
            <p>Ошибка:</p>
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% elif "success" in message.tags %}
            <p>Успех:</p>
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endif %}
          {% endfor %}
          <span class="close-button">&times;</span>
        </ul>
    </div>
    {% endif %}
  <div class="container2">
     <form method="post" enctype="multipart/form-data">
        <form method="post">
    {% csrf_token %}
    {{ recipe_form.as_p }}

    <h3>Шаги</h3>
    <div id="formset-container">
        {{ formset.management_form }}
        {% for form in formset %}
            <div class="step-form">
                {{ form.as_p }}
            </div>
        {% endfor %}
    </div>

    <button type="button" id="add-step-btn">Добавить шаг</button>
    <br><br>
    <button type="submit">Создать рецепт</button>
</form>
      </form>
  </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let formsetContainer = document.getElementById('formset-container');
        let addStepBtn = document.getElementById('add-step-btn');

        let totalForms = document.querySelector('#id_form-TOTAL_FORMS');
        let formNum = formsetContainer.querySelectorAll('.step-form').length;

        addStepBtn.addEventListener('click', function(e) {
            // Создаем новый шаг формы на основе первого шага
            let newForm = formsetContainer.querySelector('.step-form').cloneNode(true);

            // Обновляем имена и id полей для нового шага
            let formRegex = RegExp(form-(\\d){1}-, 'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, form-${formNum}-);

            // Очищаем значения полей
            newForm.querySelector('textarea').value = '';

            formsetContainer.appendChild(newForm);
            formNum++;
            totalForms.value = formNum;  // Обновляем значение totalForms
        });
    });
</script>
{% endblock %}